<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title data-i18n="title">UB Weather & Air Quality</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&family=Outfit:wght@400;600;700&display=swap"
    rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root {
      --bg-color: #f0f2f5;
      --card-bg: #ffffff;
      --text-main: #1a1a1a;
      --text-sub: #666;
      --accent: #2563eb;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --card-radius: 20px;
      --transition: all 0.3s ease;

      /* AQI Colors */
      --aqi-good: #10b981;
      --aqi-moderate: #f59e0b;
      --aqi-sensitive: #f97316;
      --aqi-unhealthy: #ef4444;
      --aqi-very-unhealthy: #8b5cf6;
      --aqi-hazardous: #7f1d1d;
    }

    body.dark {
      --bg-color: #0f172a;
      --card-bg: #1e293b;
      --text-main: #f8fafc;
      --text-sub: #94a3b8;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      margin: 0;
      padding: 20px;
      transition: var(--transition);
    }

    h1,
    h2,
    h3 {
      font-family: 'Outfit', sans-serif;
      margin: 0;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Header */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 10px 0;
    }

    .header-title h1 {
      font-size: 1.8rem;
      font-weight: 700;
    }

    .header-title p {
      color: var(--text-sub);
      font-size: 0.9rem;
      margin-top: 4px;
    }

    .controls-wrapper {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .btn {
      background: var(--card-bg);
      color: var(--text-main);
      border: 1px solid rgba(128, 128, 128, 0.2);
      padding: 8px 16px;
      border-radius: 12px;
      cursor: pointer;
      font-family: 'Outfit', sans-serif;
      font-weight: 500;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 6px;
      text-decoration: none;
      font-size: 0.9rem;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    select {
      background: var(--card-bg);
      color: var(--text-main);
      border: 1px solid rgba(128, 128, 128, 0.2);
      padding: 8px 12px;
      border-radius: 12px;
      font-family: 'Inter', sans-serif;
      cursor: pointer;
    }

    /* Dashboard Layout */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: auto auto;
      gap: 20px;
      margin-bottom: 30px;
    }

    /* Bento Cards */
    .card {
      background: var(--card-bg);
      border-radius: var(--card-radius);
      padding: 24px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }

    /* Hero: Average AQI - Spans 2 columns */
    .hero-card {
      grid-column: span 2;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: linear-gradient(135deg, var(--card-bg), var(--bg-color));
      min-height: 220px;
    }

    .aqi-circle {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border: 8px solid var(--aqi-good);
      margin-bottom: 16px;
      position: relative;
    }

    .aqi-value {
      font-size: 2.5rem;
      font-weight: 700;
      line-height: 1;
    }

    .aqi-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      color: var(--text-sub);
    }

    .hero-status {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-main);
    }

    .last-updated {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 0.8rem;
      color: var(--text-sub);
    }

    /* Weather Card - Spans 2 columns */
    .weather-card {
      grid-column: span 2;
      display: flex;
      flex-direction: row;
      justify-content: space-around;
      align-items: center;
    }

    .weather-item {
      text-align: center;
    }

    .weather-icon {
      font-size: 2.5rem;
      margin-bottom: 8px;
    }

    .weather-val {
      font-size: 1.8rem;
      font-weight: 700;
    }

    .weather-desc {
      color: var(--text-sub);
      font-size: 0.9rem;
    }

    /* Stations Grid Area */
    .stations-container {
      grid-column: span 4;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
    }

    .station-card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 16px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      border-left: 6px solid transparent;
      /* Colored Accent */
    }

    .station-name {
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 4px;
    }

    .station-val {
      font-size: 1.8rem;
      font-weight: 700;
      margin: 8px 0;
    }

    .station-trend {
      font-size: 0.8rem;
      color: var(--text-sub);
    }

    /* Charts Section */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
      gap: 20px;
    }

    .chart-card {
      grid-column: span 1;
      height: 400px;
    }

    .chart-card.full-width {
      grid-column: span 2;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }

      .hero-card,
      .weather-card {
        grid-column: span 1;
      }

      .stations-container {
        grid-column: span 1;
        grid-template-columns: repeat(2, 1fr);
      }

      .charts-grid {
        grid-template-columns: 1fr;
      }

      .chart-card.full-width {
        grid-column: span 1;
      }
    }

    @media (max-width: 600px) {
      .stations-container {
        grid-template-columns: 1fr;
      }

      .header-title h1 {
        font-size: 1.4rem;
      }

      .controls-wrapper {
        display: none;
        /* Hide complexity on mobile for now, or stack */
      }
    }

    /* Footer */
    footer {
      text-align: center;
      margin-top: 50px;
      color: var(--text-sub);
      font-size: 0.9rem;
      border-top: 1px solid rgba(128, 128, 128, 0.1);
      padding-top: 20px;
    }

    footer a {
      color: var(--accent);
      text-decoration: none;
    }
  </style>
  <!-- 100% privacy-first analytics -->
  <script async src="https://scripts.simpleanalyticscdn.com/latest.js"></script>
</head>

<body>

  <div class="container">
    <header>
      <div class="header-title">
        <h1 data-i18n="title">UB Air & Weather</h1>
        <p data-i18n="desc">Real-time environmental monitoring</p>
      </div>
      <div class="controls-wrapper">
        <button class="btn" onclick="toggleDarkMode()" id="darkModeBtn">üåô</button>
        <button class="btn" onclick="toggleLanguage()" id="langBtn">üá¨üáß</button>
        <select id="rangeSelect" onchange="renderAggregated()">
          <option value="today">24h</option>
          <option value="last7">7 Days</option>
          <option value="last30">30 Days</option>
          <option value="all">All Time</option>
        </select>
        <a href="weather_log.csv" class="btn" download>üì• CSV</a>
      </div>
    </header>

    <div class="dashboard-grid">
      <!-- Hero: Average AQI -->
      <div class="card hero-card">
        <div id="lastUpdated" class="last-updated">Updating...</div>
        <div class="aqi-circle" id="heroAqiCircle">
          <span class="aqi-value" id="heroAqiVal">--</span>
          <span class="aqi-label">Avg PM2.5</span>
        </div>
        <div class="hero-status" id="heroStatus">Loading...</div>
      </div>

      <!-- Weather Summary -->
      <div class="card weather-card">
        <div class="weather-item">
          <div class="weather-icon">üå°Ô∏è</div>
          <div class="weather-val" id="weatherTemp">--¬∞</div>
          <div class="weather-desc" data-i18n="temperature">Temp</div>
        </div>
        <div class="weather-item">
          <div class="weather-icon">üíß</div>
          <div class="weather-val" id="weatherHum">--%</div>
          <div class="weather-desc" data-i18n="humidity">Humidity</div>
        </div>
        <div class="weather-item">
          <div class="weather-icon">üí®</div>
          <div class="weather-val" id="weatherWind">--</div>
          <div class="weather-desc" data-i18n="wind">Wind (m/s)</div>
        </div>
      </div>

      <!-- Station Cards -->
      <div class="stations-container" id="stationsGrid">
        <!-- Injected via JS -->
      </div>
    </div>

    <div class="charts-grid">
      <div class="card chart-card full-width">
        <canvas id="pmChart"></canvas>
      </div>
      <div class="card chart-card">
        <canvas id="tempChart"></canvas>
      </div>
      <div class="card chart-card">
        <canvas id="windChart"></canvas>
      </div>
    </div>

    <footer>
      <span data-i18n="footer_desc">Data from weather.gov.mn & embassies. Refreshes every 30min.</span>
      <a href="https://github.com/chuk-a/chuk-a.github.io">GitHub</a>
    </footer>
  </div>

  <script>
    // CONFIG & STATE
    const stations = [
      { id: 'french', label: 'French Embassy', flag: 'üá´üá∑' },
      { id: 'eu', label: 'EU Delegation', flag: 'üá™üá∫' },
      { id: 'czech', label: 'Czech Embassy', flag: 'üá®üáø' },
      { id: 'yarmag', label: 'Yarmag City', flag: 'üèôÔ∏è' },
      { id: 'chd9', label: 'CHD 9 Khoroo', flag: 'üèôÔ∏è' },
      { id: 'mandakh', label: 'Mandakh Naran', flag: 'üèôÔ∏è' },
      { id: 'chd6', label: 'CHD 6 Horoo', flag: 'üèôÔ∏è' },
      { id: 'airv', label: 'Air V Station', flag: 'üì°' }
    ];

    let rawData = null;
    const translations = {
      en: {
        title: "UB Air & Weather",
        desc: "Real-time environmental monitoring",
        temperature: "Temp",
        humidity: "Humidity",
        wind: "Wind (m/s)",
        footer_desc: "Data from weather.gov.mn & embassies. Refreshes every 30min."
      },
      mn: {
        title: "–£–ë –¶–∞–≥ –ê–≥–∞–∞—Ä & –ê–≥–∞–∞—Ä",
        desc: "–ë–æ–¥–∏—Ç —Ü–∞–≥–∏–π–Ω –æ—Ä—á–Ω—ã —Ö—è–Ω–∞–ª—Ç",
        temperature: "–¢–µ–º–ø",
        humidity: "–ß–∏–π–≥—à–∏–ª",
        wind: "–°–∞–ª—Ö–∏ (–º/—Å)",
        footer_desc: "weather.gov.mn –±–æ–ª–æ–Ω —ç–ª—á–∏–Ω —Å–∞–π–¥—ã–Ω —è–∞–º–¥–∞–∞—Å –º—ç–¥—ç—ç–ª—ç–ª –∞–≤–¥–∞–≥."
      }
    };

    // HELPERS
    function getLang() { return localStorage.getItem("lang") || "en"; }

    function getAQIMeta(pm25) {
      if (pm25 == null) return { color: '#e5e7eb', label: 'N/A', class: 'nodata' };
      if (pm25 <= 12) return { color: '#10b981', label: 'Good', class: 'good' };
      if (pm25 <= 35) return { color: '#f59e0b', label: 'Moderate', class: 'moderate' };
      if (pm25 <= 55) return { color: '#f97316', label: 'Unhealthy for sensitive', class: 'sensitive' };
      if (pm25 <= 150) return { color: '#ef4444', label: 'Unhealthy', class: 'unhealthy' };
      return { color: '#7f1d1d', label: 'Hazardous', class: 'hazardous' };
    }

    function cleanNumber(val) {
      if (!val || val === "ERROR") return null;
      const n = parseFloat(String(val).replace(/[^\d.-]/g, ''));
      return Number.isFinite(n) ? n : null;
    }

    // --- DATA LOADING & PARSING ---
    async function loadCSV() {
      const sources = ['weather_log.csv', 'https://raw.githubusercontent.com/chuk-a/chuk-a.github.io/main/weather_log.csv'];
      for (const src of sources) {
        try {
          const res = await fetch(src);
          if (!res.ok) throw new Error("404");
          const text = await res.text();
          parseCSV(text);
          return;
        } catch (e) { console.warn(e); }
      }
    }

    function parseCSV(text) {
      const res = Papa.parse(text.trim(), { header: true, skipEmptyLines: true });

      // Arrays
      const data = {
        timestamps: [], temps: [], feels: [], humidities: [], windSpeeds: [],
        french: [], eu: [], czech: [], yarmag: [], chd9: [], mandakh: [], chd6: [], airv: []
      };

      res.data.forEach(row => {
        data.timestamps.push(row.timestamp);
        data.temps.push(cleanNumber(row.temperature));
        data.feels.push(cleanNumber(row.feels_like));
        data.humidities.push(cleanNumber(row.humidity));
        data.windSpeeds.push(cleanNumber(row.wind_speed));

        // Stations
        stations.forEach(s => {
          data[s.id].push(cleanNumber(row[`pm25_${s.id}`]));
        });
      });

      rawData = data;
      renderDashboard();
    }

    async function renderDashboard() {
      if (!rawData) return;

      const range = document.getElementById('rangeSelect').value;
      const filtered = filterDataByRange(rawData, range);

      updateLatestValues(rawData); // Always show absolute latest for cards
      renderCharts(filtered);
    }

    function filterDataByRange(data, range) {
      if (range === 'all') return data;

      const now = new Date();
      const days = range === 'today' ? 1 : (range === 'last7' ? 7 : 30);
      const cutoff = new Date(now.getTime() - (days * 24 * 60 * 60 * 1000));

      // Find start index
      let startIdx = 0;
      for (let i = data.timestamps.length - 1; i >= 0; i--) {
        if (new Date(data.timestamps[i]) < cutoff) {
          startIdx = i + 1;
          break;
        }
      }

      if (startIdx <= 0) return data; // Return all if range is too wide or default

      // Slice all arrays
      const sliced = {};
      Object.keys(data).forEach(key => {
        sliced[key] = data[key].slice(startIdx);
      });
      return sliced;
    }

    function updateLatestValues(data) {
      const idx = data.timestamps.length - 1;
      if (idx < 0) return;

      // 1. Hero Section (Average PM2.5)
      const currentVals = stations.map(s => data[s.id][idx]).filter(v => v != null);
      const avgPM = currentVals.length ? Math.round(currentVals.reduce((a, b) => a + b, 0) / currentVals.length) : 0;
      const meta = getAQIMeta(avgPM);

      const heroCircle = document.getElementById('heroAqiCircle');
      heroCircle.style.borderColor = meta.color;
      heroCircle.style.color = meta.color;
      document.getElementById('heroAqiVal').textContent = avgPM;
      document.getElementById('heroStatus').textContent = meta.label;

      document.getElementById('lastUpdated').textContent = `Updated: ${data.timestamps[idx]}`;

      // 2. Weather Cards
      document.getElementById('weatherTemp').textContent = (data.temps[idx] ?? '--') + '¬∞';
      document.getElementById('weatherHum').textContent = (data.humidities[idx] ?? '--') + '%';
      document.getElementById('weatherWind').textContent = data.windSpeeds[idx] ?? '--';

      // 3. Station Grid
      const grid = document.getElementById('stationsGrid');
      grid.innerHTML = '';

      stations.forEach(s => {
        const val = data[s.id][idx];
        const sMeta = getAQIMeta(val);
        const div = document.createElement('div');
        div.className = 'station-card';
        div.style.borderLeftColor = sMeta.color;
        div.innerHTML = `
        <div class="station-name">${s.flag} ${s.label}</div>
        <div class="station-val" style="color: ${sMeta.color}">${val ?? '--'} <span style="font-size:0.8rem; color:var(--text-sub)">¬µg/m¬≥</span></div>
        <div class="station-trend">${sMeta.label}</div>
      `;
        grid.appendChild(div);
      });
    }

    function renderCharts(data) {
      const ctxPM = document.getElementById('pmChart');
      const ctxTemp = document.getElementById('tempChart');
      const ctxWind = document.getElementById('windChart');

      // Destroy existing
      Chart.getChart("pmChart")?.destroy();
      Chart.getChart("tempChart")?.destroy();
      Chart.getChart("windChart")?.destroy();

      // Chart Defaults
      Chart.defaults.font.family = "'Inter', sans-serif";
      Chart.defaults.color = document.body.classList.contains('dark') ? '#94a3b8' : '#64748b';
      const gridColor = document.body.classList.contains('dark') ? '#334155' : '#e2e8f0';

      const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        elements: { point: { radius: 0, hitRadius: 10 } },
        scales: {
          x: { grid: { display: false }, ticks: { maxTicksLimit: 8 } },
          y: { grid: { color: gridColor }, border: { display: false } }
        },
        plugins: {
          tooltip: { mode: 'index', intersect: false, backgroundColor: 'rgba(0,0,0,0.8)', padding: 10, cornerRadius: 8 },
          legend: { position: 'top', align: 'end', labels: { usePointStyle: true, boxWidth: 8 } }
        },
        interaction: { mode: 'nearest', axis: 'x', intersect: false }
      };

      // 1. PM2.5 Chart
      new Chart(ctxPM, {
        type: 'line',
        data: {
          labels: data.timestamps,
          datasets: stations.map(s => ({
            label: s.label,
            data: data[s.id],
            borderColor: getStationColor(s.id),
            backgroundColor: getStationColor(s.id) + '20', // Transparent fill
            borderWidth: 2,
            tension: 0.4,
            fill: false
          }))
        },
        options: {
          ...commonOptions,
          plugins: { ...commonOptions.plugins, title: { display: true, text: "PM2.5 History (¬µg/m¬≥)", align: "start", font: { size: 16, family: 'Outfit' } } }
        }
      });

      // 2. Temp Chart (Area)
      new Chart(ctxTemp, {
        type: 'line',
        data: {
          labels: data.timestamps,
          datasets: [{
            label: 'Temperature',
            data: data.temps,
            borderColor: '#f59e0b',
            backgroundColor: (context) => {
              const ctx = context.chart.ctx;
              const gradient = ctx.createLinearGradient(0, 0, 0, 300);
              gradient.addColorStop(0, 'rgba(245, 158, 11, 0.5)');
              gradient.addColorStop(1, 'rgba(245, 158, 11, 0.0)');
              return gradient;
            },
            borderWidth: 2,
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          ...commonOptions,
          plugins: { ...commonOptions.plugins, title: { display: true, text: "Temperature (¬∞C)", align: "start", font: { size: 16, family: 'Outfit' } } }
        }
      });

      // 3. Wind Chart (Bar)
      new Chart(ctxWind, {
        type: 'bar',
        data: {
          labels: data.timestamps,
          datasets: [{
            label: 'Wind Speed',
            data: data.windSpeeds,
            backgroundColor: '#3b82f6',
            borderRadius: 4
          }]
        },
        options: {
          ...commonOptions,
          plugins: { ...commonOptions.plugins, title: { display: true, text: "Wind Speed (m/s)", align: "start", font: { size: 16, family: 'Outfit' } } }
        }
      });
    }

    function getStationColor(id) {
      const map = {
        french: '#3b82f6', eu: '#8b5cf6', czech: '#ec4899', yarmag: '#10b981',
        chd9: '#f97316', mandakh: '#f59e0b', chd6: '#6366f1', airv: '#14b8a6'
      };
      return map[id] || '#999';
    }

    // --- UI TOGGLES ---
    function toggleDarkMode() {
      document.body.classList.toggle('dark');
      renderCharts(filterDataByRange(rawData, document.getElementById('rangeSelect').value));
    }
    function toggleLanguage() {
      const cur = localStorage.getItem("lang") || "en";
      localStorage.setItem("lang", cur === "en" ? "mn" : "en");
      location.reload(); // Simple reload to apply strings for now
    }

    // Init
    loadCSV();
    setInterval(loadCSV, 600000); // 10 min refresh

  </script>
</body>

</html>